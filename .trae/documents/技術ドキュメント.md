# TOEIC重要単語集（toeic_website_ver2.0）技術ドキュメント

最終更新日: 2025-12-19

## 1. プロジェクト概要

### 1.1 目的と背景
- TOEIC頻出の重要単語を、一覧・検索・詳細表示（AI生成の解説）で効率良く学習できるWebアプリを提供する
- 単語の詳細解説は、外部AI（Google Gemini）で生成し、再利用可能なキャッシュ（Upstash Redis）でコストと待ち時間を削減する
- 発音確認のため、外部TTS（Google Cloud Text-to-Speech）で音声を生成する

### 1.2 主要な技術スタックとバージョン情報
#### フレームワーク/ランタイム
| 区分 | 技術 | バージョン | 用途 |
|---|---|---:|---|
| フロント/サーバ | Next.js | 16.0.10 | App RouterでUIとAPIを同一プロジェクトで提供 |
| UI | React / React DOM | 19.2.1 | コンポーネントUI |
| 言語 | TypeScript | ^5 | 型安全な実装 |
| 実行環境 | Node.js | 20（CI設定） | 開発/ビルド/実行 |

#### 外部サービス
| 区分 | 技術 | 用途 |
|---|---|---|
| 生成AI | Google Gemini（@google/generative-ai） | 単語詳細JSONの生成 |
| キャッシュ | Upstash Redis（@upstash/redis） | 生成結果の永続キャッシュ（TTLあり） |
| 音声合成 | Google Cloud Text-to-Speech（HTTP API） | 発音音声（MP3）生成 |

#### 開発ツール
| 区分 | 技術 | バージョン | 用途 |
|---|---|---:|---|
| Lint | ESLint / eslint-config-next | ^9 / 16.0.10 | Next.js推奨ルールに準拠 |
| テスト（任意） | Vitest | ^4.0.15 | ユニットテスト実行基盤（本プロジェクト方針は手動テスト） |

### 1.3 システムアーキテクチャ概要図
```
ユーザー（ブラウザ）
  └─ 表示・操作
       └─ Next.js（App Router）
            ├─ ページ
            │    ├─ /        （トップ・一覧）
            │    └─ /words/[word]（単語詳細）
            │
            └─ API
                 ├─ GET /api/words/[word]
                 │    ├─ .doc/word.txt で単語の存在確認（src/data/words.ts）
                 │    ├─ Upstash Redis を参照（HITなら即返却）
                 │    └─ MISS時に Google Gemini で詳細JSON生成→正規化→Redis保存
                 │
                 └─ POST /api/tts
                      └─ Google Cloud Text-to-Speech を呼び出し、Base64音声(MP3)を返却
```

## 2. 基本仕様

### 2.1 システム要件（ハードウェア/ソフトウェア）
#### 開発（ローカル）
- ソフトウェア: Node.js 20系、npm（`package-lock.json`に基づき `npm ci` を推奨）
- ハードウェア: Node.js/Next.jsの開発サーバが動作する一般的なPC

#### 本番（推奨）
- Vercel等のNext.js実行環境（リポジトリにはVercel用ワークフローが同梱）

### 2.2 動作環境条件
#### 必須の環境変数
`.env.example` に定義された以下を設定する（開発は `.env.local` を推奨）。
- `GEMINI_API_KEY`: Gemini APIキー
- `TTS_API_KEY`: Google Cloud Text-to-Speech APIキー
- `UPSTASH_REDIS_REST_URL`: Upstash Redis REST URL
- `UPSTASH_REDIS_REST_TOKEN`: Upstash Redis REST Token
- `WORD_CACHE_TTL_DAYS`: 単語詳細キャッシュTTL（日）。未設定時は30日

#### データ要件
- 単語一覧は `./.doc/word.txt` を唯一のソースとして読み込む
  - 実装は `src/data/words.ts` で `process.cwd()` 基準に `".doc/word.txt"` を参照する

### 2.3 対応ブラウザ/デバイス
- 主要なモダンブラウザ（最新2世代を目安）
  - Chrome / Edge / Firefox / Safari
- PC/スマートフォンのWebブラウザ（レスポンシブはCSSで調整）

### 2.4 パフォーマンス指標
外部API（Gemini/TTS）の応答時間に強く依存するため、本項は「観測可能な指標」と「目標」を定義する。

#### 観測可能な指標
- `GET /api/words/[word]` レスポンスヘッダー
  - `X-Cache`: `HIT` / `MISS` / `BYPASS`
  - `X-Generation-Time`: 生成（Gemini）に要した時間（`MISS`時のみ付与）
- キャッシュTTL
  - ブラウザ: `localStorage` に 24時間保持（詳細ページの再訪でネットワークをスキップ）
  - サーバ: Upstashに `WORD_CACHE_TTL_DAYS` 日保持

#### 目標（運用基準）
- `X-Cache=HIT` での単語詳細表示が体感的に即時（CDN/Redisのヒットで待ちを最小化）
- `X-Cache=MISS` でもタイムアウトやエラー時に再試行可能（詳細ページに再読み込み導線）

## 3. 技術詳細

### 3.1 採用技術の選定理由
- Next.js（App Router）
  - ページ/UIとAPI（Route Handlers）を同一リポジトリで管理でき、Vercelへのデプロイが容易
  - 静的生成/サーバ実行を用途に応じて使い分け可能
- Google Gemini（@google/generative-ai）
  - TOEIC向けの「所定JSONスキーマ」で語義・例文等を生成する用途に適合
  - API側で正規化・型ガードを行い、フロント表示の安定性を確保
- Upstash Redis
  - サーバレス環境と相性が良いRESTベースのRedisで、生成結果を長期TTLで再利用可能
- Google Cloud Text-to-Speech
  - 発音音声をMP3で生成し、ブラウザで即再生できる

### 3.2 主要なライブラリと依存関係
- `next`, `react`, `react-dom`: アプリ本体
- `@google/generative-ai`: `GET /api/words/[word]` でGeminiを呼び出す
- `@upstash/redis`: サーバ側キャッシュ（`src/lib/upstash.ts`, `src/lib/wordCache.ts`）

### 3.3 開発環境構築手順
1. 依存関係インストール
   - `npm ci`
2. 環境変数の設定
   - `.env.example` を参考に `.env.local` を作成し、各キーを設定
3. 単語データ配置
   - `./.doc/word.txt` が存在することを確認（1行1単語）
4. 開発サーバ起動
   - `npm run dev`
5. 動作確認
   - `http://localhost:3000` を開き、単語一覧→詳細→音声再生を確認

### 3.4 ビルド/デプロイ方法
#### ローカルビルド
- `npm run build`
- `npm run start`

#### GitHub Actions（CI）
- 定義: `.github/workflows/ci.yml`
- 実行: PRおよび `main` へのpushで `npm ci` → `npm run lint` → `npm run build`

#### Vercelデプロイ（GitHub Actions）
- Preview: `.github/workflows/vercel-preview.yml`
  - `main` 以外のブランチpushで、Vercel CLI により Preview 環境へデプロイ
- Production: `.github/workflows/vercel-production.yml`
  - `workflow_dispatch`（手動実行）で Production へデプロイ

## 4. コンポーネント仕様

### 4.1 各コンポーネントの役割と機能
#### ページ/UI
- トップページ `src/app/page.tsx`
  - 単語一覧（`src/data/words.ts`）を取得し、クライアント側一覧UIへ渡す
- 単語一覧UI `src/app/WordsListClient.tsx`（Client Component）
  - 検索（前方一致）、ページング（20件/ページ）
  - 詳細ページへの遷移リンク（`/words/[slug]`）
- 単語詳細ページ `src/app/words/[word]/page.tsx`
  - 存在しない単語は `notFound()` で404
  - 詳細表示は `dynamic import` でクライアントコンポーネントを遅延ロード
- 単語詳細UI `src/app/words/[word]/WordDetailClient.tsx`（Client Component）
  - `GET /api/words/[word]` でAI生成の詳細を取得
  - `localStorage` へ24時間キャッシュし、再訪時はネットワーク取得をスキップ
  - 発音ボタンで `POST /api/tts` を呼び出し、返却されたBase64音声を再生

#### 共有/ユーティリティ
- 単語データ `src/data/words.ts`
  - `./.doc/word.txt` を読み込み、`Word[]` をメモリ保持
- Upstash接続 `src/lib/upstash.ts`
  - 環境変数からRedisクライアントを初期化し、シングルトンとして利用
- 単語詳細キャッシュ `src/lib/wordCache.ts`
  - `word:<lowercased>` のキーで `WordDetails` をJSONとして保存/取得

### 4.2 コンポーネント間の連携フロー
#### 単語詳細の取得（AI + キャッシュ）
1. ブラウザが `/words/[word]` を開く
2. `WordDetailClient` が `localStorage` を確認（有効なら表示して終了）
3. 未キャッシュの場合、`GET /api/words/[word]` を呼ぶ
4. サーバ側でUpstashを参照
   - キャッシュあり: `X-Cache=HIT` で即返却
   - キャッシュなし: Geminiで生成 → 正規化 → Upstashへ保存 → `X-Cache=MISS` で返却
   - Upstash障害: キャッシュを諦めて生成し、`X-Cache=BYPASS` で返却
5. ブラウザは取得結果を描画し、`localStorage` に保存（24時間）

#### 発音音声の生成（TTS）
1. ブラウザが `POST /api/tts` に `{ "text": "word" }` を送信
2. サーバが Google Text-to-Speech API を呼び出し、`audioContent`（Base64）を取得
3. ブラウザが `data:audio/mp3;base64,...` として生成し、再生する

### 4.3 API仕様
#### 4.3.1 `GET /api/words/[word]`
- 概要: 単語詳細（AI生成）を返却。Upstashでキャッシュし再利用する
- パスパラメータ
  - `word`: `src/data/words.ts` に存在する `slug`（小文字）
- レスポンス（200）
  - `Content-Type: application/json`
  - `X-Cache: HIT | MISS | BYPASS`
  - `X-Generation-Time: <ms>`（MISS時）
  - `Cache-Control: public, max-age=0, s-maxage=86400, stale-while-revalidate=604800`
- エラー
  - 404: `{ "error": "Word not found" }`
  - 500: `{ "error": "GEMINI_API_KEY is not configured" }` 等

リクエスト例:
```bash
curl -sS http://localhost:3000/api/words/increase
```

レスポンス例（抜粋）:
```json
{
  "word": "increase",
  "pronunciation": "/ɪnˈkriːs/",
  "meanings": [
    {
      "partOfSpeech": "動詞",
      "meaning": "〜を増やす、増加させる。",
      "detailedMeanings": [
        {
          "number": 1,
          "definition": "数量や程度を増やす",
          "example": "We need to increase sales.",
          "exampleJapanese": "売上を増やす必要がある。",
          "context": "ビジネス",
          "frequency": "高",
          "synonyms": ["raise", "boost"],
          "grammarPattern": "increase A"
        }
      ]
    }
  ],
  "wordForms": [{"form":"increased","type":"過去形"}],
  "synonyms": ["raise"],
  "nuance": "数量や規模の増加を客観的に述べる語。",
  "toeicExamples": [{"english":"...","japanese":"..."}],
  "englishDefinition": "To become or make something larger.",
  "japaneseTranslation": "増加（する）"
}
```

#### 4.3.2 `POST /api/tts`
- 概要: 指定テキストの英語音声（MP3）を生成して返す
- リクエストボディ（JSON）
  - `text`: string（必須）
- レスポンス（200）
  - `{ "audioContent": "<base64>" }`
  - `Cache-Control: public, max-age=86400`
- エラー
  - 400: `{ "error": "Invalid request body" }`
  - 500: `{ "error": "TTS_API_KEY is not configured" }` 等

リクエスト例:
```bash
curl -sS http://localhost:3000/api/tts \
  -H "Content-Type: application/json" \
  -d '{"text":"increase"}'
```

### 4.4 データモデル定義
#### 4.4.1 単語一覧
```ts
export type Word = {
  slug: string;
  term: string;
};
```

#### 4.4.2 単語詳細（AI生成）
```ts
export type WordDetails = {
  word: string;
  pronunciation: string;
  meanings: Array<{
    partOfSpeech: string;
    meaning: string;
    detailedMeanings: Array<{
      number: number;
      definition: string;
      example: string;
      exampleJapanese: string;
      context: string;
      frequency: string;
      synonyms: string[];
      grammarPattern?: string;
    }>;
  }>;
  wordForms: Array<{ form: string; type: string }>;
  synonyms: string[];
  nuance: string;
  toeicExamples: Array<{ english: string; japanese: string }>;
  englishDefinition: string;
  japaneseTranslation: string;
  etymology?: string;
  usageNotes?: {
    commonCollocations?: string[];
    register?: string;
    regionalVariations?: string;
  };
};
```

## 5. 開発ガイドライン

### 5.1 コーディング規約
- TypeScriptの`strict`を前提に実装する（`tsconfig.json`）
- Next.js App Routerの構造に従い、UIは `src/app/**` 配下に配置する
- import alias `@/*` を使用する（`@` は `src` を指す）
- Lintは `npm run lint` を必ず通す（`eslint-config-next` の推奨に準拠）

### 5.2 テスト方針（手動）
本プロジェクトのテストは手動を基本とする。
- トップページ
  - 一覧表示、検索（前方一致）、ページングが期待通りに動作する
- 詳細ページ
  - 既知の単語は表示され、未知の単語は404になる
  - `X-Cache` が `HIT/MISS` で切り替わる（同一単語の再アクセスでHITを確認）
  - 発音ボタンで音声が再生される
- エラー系
  - `GEMINI_API_KEY` 未設定で `GET /api/words/[word]` が500になる
  - `TTS_API_KEY` 未設定で `POST /api/tts` が500になる

### 5.3 バージョン管理ルール
- `main` は保護ブランチ扱いを想定し、変更はPR経由で取り込む
- CI（lint/build）が通過することをマージ条件とする
- Previewデプロイは `main` 以外のブランチpushで実行される
- Productionデプロイは手動（`workflow_dispatch`）で実行する

### 5.4 ドキュメント更新手順
- 仕様変更（API、データモデル、キャッシュ戦略、環境変数）が入った場合は本ドキュメントを同時に更新する
- 更新時は「更新履歴」に日付・変更概要を追記する

## 更新履歴
| 日付 | 版 | 変更者 | 変更内容 |
|---|---|---|---|
| 2025-12-19 | 1.0 | - | 初版作成 |
